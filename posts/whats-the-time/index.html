<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><title>What's the time? | Balázs' blog</title>
<link rel=canonical href=https://balazs.kutilovi.cz/posts/whats-the-time/><link href=https://balazs.kutilovi.cz/index.xml rel=alternate type=application/rss+xml title="Balázs' blog"><link rel="shortcut icon" type=image/svg+xml href="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20fill=%22none%22%20viewBox=%220%200%2024%2024%22%20stroke-width=%221.5%22%20stroke=%22currentcolor%22%20color=%22grey%22%3E%3Cpath%20stroke-linecap=%22round%22%20stroke-linejoin=%22round%22%20d=%22M10.34%2015.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5%204.5.0%20110-9h.75c.704.0%201.402-.03%202.09-.09m0%209.18c.253.962.584%201.892.985%202.783.247.55.06%201.21-.463%201.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845%2020.845.0%2001-1.44-4.282m3.102.069a18.03%2018.03.0%2001-.59-4.59c0-1.586.205-3.124.59-4.59m0%209.18a23.848%2023.848.0%20018.835%202.535M10.34%206.66a23.847%2023.847.0%20008.835-2.535m0%200A23.74%2023.74.0%200018.795%203m.38%201.125a23.91%2023.91.0%20011.014%205.395m-1.014%208.855c-.118.38-.245.754-.38%201.125m.38-1.125a23.91%2023.91.0%20001.014-5.395m0-3.46c.495.413.811%201.035.811%201.73s-.316%201.317-.811%201.73m0-3.46a24.347%2024.347.0%20010%203.46%22/%3E%3C/svg%3E"><style>/*!modern-normalize v2.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize*/*,::before,::after{box-sizing:border-box}html{font-family:system-ui,segoe ui,Roboto,Helvetica,Arial,sans-serif,apple color emoji,segoe ui emoji;line-height:1.15;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4}body{margin:0}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:ui-monospace,SFMono-Regular,Consolas,liberation mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}button,[type=button],[type=reset],[type=submit]{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}</style><style>html{line-height:1.5}h1{font-size:2.136rem}h2{font-size:1.898rem}h3{font-size:1.688rem}body{max-width:32rem;padding:.74rem;margin:auto}blockquote{margin-left:1.688rem;padding-left:.74rem;border-left:.461rem #ddd solid}p code{font-size:.936rem;margin:0 .288rem}img{max-width:100%;height:auto}pre{font-size:.74rem;margin:1.688rem 0;padding:.936rem;overflow-x:scroll}footer{margin:1.688rem 0}footer nav{margin:1.688rem 0}</style></head><body><header><h1>Balázs' blog</h1><nav><span><a href=/>Posts</a>
</span><span><a href=/about/>About</a></span></nav></header><main><h2>What's the time?</h2><time datetime=2024-03-04T08:04:30+01:00>March 4, 2024</time><p>I&rsquo;ve been running some profiling on the <a href=https://plainapm.com>PlainApm</a>
agent and one of the things that sometimes popped up in the <code>stackprof</code>
output were calls to <code>(Date)Time#iso8601</code>. I used them to get an idea of
the overall pipeline latency from the moment the event gets collected
until it gets written to the DB.</p><p>It turns out that these calls are indeed quite slow, so depending
on the use case, <code>Time.now.to_f</code> or
<code>Process.clock_gettime(Process::CLOCK_MONOTONIC)</code> might be a faster
alternative.</p><p>Here&rsquo;s a <a href=https://github.com/bkutil/experiments/blob/main/2024-02-28-datetime-vs-time-iso/bench.rb>micro-benchmark</a> with some more variants
thrown into the mix - the strftime format string is <a href=https://github.com/ruby/ruby/blob/eb6eb1d4e8572fffd7bce6789eb8e87669293eef/ext/date/date_core.c#L8755>an equivalent to iso8601</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#036;font-weight:700>Time</span>.now.to_f - float, <span style=color:#a60;background-color:#fff0f0>epoch</span>:         <span style=color:#00d;font-weight:700>2157540</span>.<span style=color:#00d;font-weight:700>4</span> i/s
</span></span><span style=display:flex><span><span style=color:#036;font-weight:700>Time</span>.now.to_f.to_s - string, <span style=color:#a60;background-color:#fff0f0>epoch</span>:    <span style=color:#00d;font-weight:700>459280</span>.<span style=color:#00d;font-weight:700>3</span> i/s -  <span style=color:#00d;font-weight:700>4</span>.<span style=color:#00d;font-weight:700>70</span>x  slower
</span></span><span style=display:flex><span><span style=color:#036;font-weight:700>Time</span>.now.utc.to_s - string, <span style=color:#a60;background-color:#fff0f0>UTC</span>:       <span style=color:#00d;font-weight:700>369579</span>.<span style=color:#00d;font-weight:700>1</span> i/s -  <span style=color:#00d;font-weight:700>5</span>.<span style=color:#00d;font-weight:700>84</span>x  slower
</span></span><span style=display:flex><span><span style=color:#036;font-weight:700>Time</span>.now.to_s - string, <span style=color:#a60;background-color:#fff0f0>localtime</span>:     <span style=color:#00d;font-weight:700>296734</span>.<span style=color:#00d;font-weight:700>2</span> i/s -  <span style=color:#00d;font-weight:700>7</span>.<span style=color:#00d;font-weight:700>27</span>x  slower
</span></span><span style=display:flex><span><span style=color:#036;font-weight:700>Time</span>.now.strftime(<span style=color:#d20;background-color:#fff0f0>&#39;%FT%T.%9N%:z&#39;</span>):     <span style=color:#00d;font-weight:700>250578</span>.<span style=color:#00d;font-weight:700>4</span> i/s -  <span style=color:#00d;font-weight:700>8</span>.<span style=color:#00d;font-weight:700>61</span>x  slower
</span></span><span style=display:flex><span><span style=color:#036;font-weight:700>Time</span>.now.iso8601(<span style=color:#00d;font-weight:700>9</span>):                   <span style=color:#00d;font-weight:700>191786</span>.<span style=color:#00d;font-weight:700>8</span> i/s - <span style=color:#00d;font-weight:700>11</span>.<span style=color:#00d;font-weight:700>25</span>x  slower
</span></span><span style=display:flex><span><span style=color:#036;font-weight:700>DateTime</span>.now.iso8601(<span style=color:#00d;font-weight:700>9</span>) - <span style=color:#a60;background-color:#fff0f0>baseline</span>:    <span style=color:#00d;font-weight:700>146311</span>.<span style=color:#00d;font-weight:700>0</span> i/s - <span style=color:#00d;font-weight:700>14</span>.<span style=color:#00d;font-weight:700>75</span>x  slower
</span></span><span style=display:flex><span><span style=color:#036;font-weight:700>DateTime</span>.now.strftime(<span style=color:#d20;background-color:#fff0f0>&#39;%FT%T.%9N%:z&#39;</span>): <span style=color:#00d;font-weight:700>135389</span>.<span style=color:#00d;font-weight:700>0</span> i/s - <span style=color:#00d;font-weight:700>15</span>.<span style=color:#00d;font-weight:700>94</span>x  slower
</span></span></code></pre></div><p>The absolute numbers are not meaningful, as the benchmark was running
inside a VM, but I&rsquo;ve found the relative slowdowns to be quite
consistent to when it ran on native HW.</p><p>My hunch is that <code>DateTime#iso8601</code> is slow due to the string
<a href=https://github.com/ruby/ruby/blob/eb6eb1d4e8572fffd7bce6789eb8e87669293eef/ext/date/date_core.c#L8762>allocation/formatting</a>, and having to take time zones into account.</p><p>What&rsquo;s also interesting is that the <code>Time</code>&rsquo;s
<a href=https://github.com/ruby/ruby/blob/ade02f3c8909a8bf630af2c88f00b7bd7ff02682/time.c#L5175>version</a>
is faster than the <code>DateTime</code>&rsquo;s.</p><p>Compared to that, <code>Time.now.to_f</code> runs surprisingly fast, but the gotcha is that
the time might get <a href=https://docs.ruby-lang.org/en/master/Time.html#method-i-to_f>rounded/truncated</a>,
so this <a href=https://github.com/ruby/ruby/blob/eb6eb1d4e8572fffd7bce6789eb8e87669293eef/time.c#L592>loses some precision</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ruby data-lang=ruby><span style=display:flex><span>irb(main):<span style=color:#00d;font-weight:700>001</span>&gt; now = <span style=color:#036;font-weight:700>Time</span>.now
</span></span><span style=display:flex><span>=&gt; <span style=color:#00d;font-weight:700>2024</span>-<span style=color:#00d;font-weight:700>03</span>-<span style=color:#00d;font-weight:700>04</span> <span style=color:#00d;font-weight:700>17</span>:<span style=color:#00d;font-weight:700>36</span>:<span style=color:#00d;font-weight:700>03</span>.<span style=color:#00d;font-weight:700>146909775</span> +<span style=color:#00d;font-weight:700>0100</span>
</span></span><span style=display:flex><span>irb(main):<span style=color:#00d;font-weight:700>002</span>&gt; now.strftime(<span style=color:#d20;background-color:#fff0f0>&#34;%9N&#34;</span>)
</span></span><span style=display:flex><span>=&gt; <span style=color:#d20;background-color:#fff0f0>&#34;146909775&#34;</span>
</span></span><span style=display:flex><span>irb(main):<span style=color:#00d;font-weight:700>003</span>&gt; <span style=color:#036;font-weight:700>Time</span>.at(now.to_f).strftime(<span style=color:#d20;background-color:#fff0f0>&#34;%9N&#34;</span>)
</span></span><span style=display:flex><span>=&gt; <span style=color:#d20;background-color:#fff0f0>&#34;146909713&#34;</span>
</span></span></code></pre></div><p>For reporting an interval of time coming from the same host, the
<a href=https://docs.ruby-lang.org/en/3.3/Process.html#method-c-clock_gettime>monotonic time</a>
would be a better choice, as it doesn&rsquo;t suffer from backwards jumps on
daylight-savings changes and NTP syncs.</p><p>It can be either called directly, with an appropriate clock type, or
through a wrapper like <a href=https://github.com/Freaky/monotime>monotime</a>,
or <a href=https://github.com/copiousfreetime/hitimes>hitimes</a>.</p><p>It is also much faster, even more than <code>Time.now.to_f</code> (about 2x):</p><pre tabindex=0><code>Process.clock_gettime - monotonic: 5129510.3 i/s
</code></pre><p>But for measuring approximate latency across (hopefully) NTP-synced,
geographically close hosts, a floating point timestamp will probably do
the job, so that&rsquo;s what I ended up using. Getting a higher accuracy, or
an error estimate seems to be a <a href=https://networkengineering.stackexchange.com/a/55541>rabbit
hole</a> though.</p><p>Perhaps for another time.</p></main><footer><nav><a href=https://balazs.kutilovi.cz/posts/how-not-to-benchmark-a-rails-app/>&#171; How Not to Benchmark a Rails App</a></nav><div><a href=https://balazs.kutilovi.cz/index.xml title="Balázs' blog" target=_blank>RSS</a>
<a href=https://twitter.com/balazs_kutil target=_blank>Twitter</a>
<a rel=me href=https://ruby.social/@balazs target=_blank>Mastodon</a>
<a href=https://linkedin.com/in/balazs-kutil target=_blank>Linkedin</a>
<a href=https://github.com/bkutil target=_blank>GitHub</a></div></footer></body></html>