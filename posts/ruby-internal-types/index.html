<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><title>Ruby Internal Types | Balázs' blog</title>
<link rel=canonical href=https://balazs.kutilovi.cz/posts/ruby-internal-types/><link href=https://balazs.kutilovi.cz/index.xml rel=alternate type=application/rss+xml title="Balázs' blog"><link rel="shortcut icon" type=image/svg+xml href="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20fill=%22none%22%20viewBox=%220%200%2024%2024%22%20stroke-width=%221.5%22%20stroke=%22currentcolor%22%20color=%22grey%22%3E%3Cpath%20stroke-linecap=%22round%22%20stroke-linejoin=%22round%22%20d=%22M10.34%2015.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5%204.5.0%20110-9h.75c.704.0%201.402-.03%202.09-.09m0%209.18c.253.962.584%201.892.985%202.783.247.55.06%201.21-.463%201.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845%2020.845.0%2001-1.44-4.282m3.102.069a18.03%2018.03.0%2001-.59-4.59c0-1.586.205-3.124.59-4.59m0%209.18a23.848%2023.848.0%20018.835%202.535M10.34%206.66a23.847%2023.847.0%20008.835-2.535m0%200A23.74%2023.74.0%200018.795%203m.38%201.125a23.91%2023.91.0%20011.014%205.395m-1.014%208.855c-.118.38-.245.754-.38%201.125m.38-1.125a23.91%2023.91.0%20001.014-5.395m0-3.46c.495.413.811%201.035.811%201.73s-.316%201.317-.811%201.73m0-3.46a24.347%2024.347.0%20010%203.46%22/%3E%3C/svg%3E"><style>/*!modern-normalize v2.0.0 | MIT License | https://github.com/sindresorhus/modern-normalize*/*,::before,::after{box-sizing:border-box}html{font-family:system-ui,segoe ui,Roboto,Helvetica,Arial,sans-serif,apple color emoji,segoe ui emoji;line-height:1.15;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4}body{margin:0}hr{height:0;color:inherit}abbr[title]{text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:ui-monospace,SFMono-Regular,Consolas,liberation mono,Menlo,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,select{text-transform:none}button,[type=button],[type=reset],[type=submit]{-webkit-appearance:button}::-moz-focus-inner{border-style:none;padding:0}:-moz-focusring{outline:1px dotted ButtonText}:-moz-ui-invalid{box-shadow:none}legend{padding:0}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}</style><style>html{line-height:1.5}h1{font-size:2.136rem}h2{font-size:1.898rem}h3{font-size:1.688rem}body{max-width:32rem;padding:.74rem;margin:auto}blockquote{margin-left:1.688rem;padding-left:.74rem;border-left:.461rem #ddd solid}p code{font-size:.936rem;margin:0 .288rem}img{max-width:100%;height:auto}pre{font-size:.74rem;margin:1.688rem 0;padding:.936rem;overflow-x:scroll}footer{margin:1.688rem 0}footer nav{margin:1.688rem 0}</style></head><body><header><h1>Balázs' blog</h1><nav><span><a href=/>Posts</a>
</span><span><a href=/about/>About</a></span></nav></header><main><h2>Ruby Internal Types</h2><time datetime=2024-02-23T20:09:28+01:00>February 23, 2024</time><p>While working on <a href=https://plainapm.com>PlainAPM</a>&rsquo;s object allocation
tracing callback, I needed a way to determine classes of arbitrary objects
returned by <a href=https://github.com/ruby/ruby/blob/ce8531fed4c7295aee94d24124914441db578136/vm_trace.c#L1084>rb_tracearg_object</a>.</p><p>The naive way, calling
<a href=https://github.com/ruby/ruby/blob/ec6532b458b34e907a2474bab70642414bbb0d05/variable.c#L424>rb_obj_classname</a>
was segfaulting, though, so I decided to handle this type-by-type, and either
avoid the problem, or narrow down the scope of the issue, to understand it
better.</p><p>Here are some notes that might save fifteen minutes to a future me, or to
someone who&rsquo;s starting to look into which types of objects are there in Ruby:</p><p>The internal types are defined by the <code>ruby_value_type</code> enum in
<a href=https://github.com/ruby/ruby/blob/04729fe68dceddab045be7324e26c2bb15aa62c7/include/ruby/internal/value_type.h#L109>value_type.h</a>.
Follow the comments from there.</p><p>A seemingly exhaustive <code>switch</code> based on the <code>BUILTIN_TYPE(obj)</code>, lives
in the objspace extension&rsquo;s
<a href=https://github.com/ruby/ruby/blob/04729fe68dceddab045be7324e26c2bb15aa62c7/ext/objspace/objspace_dump.c#L432>objspace_dump.c</a>.
The same file also includes Ruby API functions for inspecting properties
of those types, which is especially useful for debugging.</p><p>Some of these types - <code>T_ARRAY</code>, <code>T_CLASS</code>, etc, correspond to what you usually
think of as a Ruby object. Then a good bet is to go and check the header files in the
<a href=https://github.com/ruby/ruby/tree/04729fe68dceddab045be7324e26c2bb15aa62c7/include/ruby/internal/core>include/ruby/internal/core</a> directory for a definition of the corresponding struct.</p><p>Some types like <code>T_IMEMO</code> (this one is for debugging) or <code>T_MOVED</code> (related to
GC compaction) correspond to a struct without a <code>RBasic</code> member, so they won&rsquo;t
have a class.</p><p>Last but not least, Ruby also has a <code>T_ZOMBIE</code> type, backed by a struct called
<code>RZombie</code> - a decent punk rock band name if you ask me.</p><p>And, yes, if you were wondering, there <em>is</em> a
<a href=https://github.com/ruby/ruby/blob/01c7e16c0ce66cfa745d49cd4f18d43c23dbe225/gc.c#L3388>make_zombie</a>
function&mldr; You are welcome :)</p></main><footer><nav><a href=https://balazs.kutilovi.cz/posts/dtracing-the-ruby-gvl/>&#171; DTracing the Ruby GVL</a>
—
<a href=https://balazs.kutilovi.cz/posts/how-not-to-benchmark-a-rails-app/>How Not to Benchmark a Rails App &#187;</a></nav><div><a href=https://balazs.kutilovi.cz/index.xml title="Balázs' blog" target=_blank>RSS</a>
<a href=https://twitter.com/balazs_kutil target=_blank>Twitter</a>
<a rel=me href=https://ruby.social/@balazs target=_blank>Mastodon</a>
<a href=https://linkedin.com/in/balazs-kutil target=_blank>Linkedin</a>
<a href=https://github.com/bkutil target=_blank>GitHub</a></div></footer></body></html>